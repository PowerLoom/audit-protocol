# Powerloom-protocol

Audit data by snapshotting payloads. Keep track of changes for each successive payload committed. 
Proof for the state for each payload at a particular time is represented by the transaction hash 
generated by committing the payload Cid to a smart contract. Each payload Cid is also wrapped up 
in a DAG structure, and each DAG structure houses the cid of the previous DAG, along with the
transaction hash for the payload and timestamp at which that payload was committed.

## Requirements
* Redis (This [link](https://redis.io/topics/quickstart) will guide you on installing redis-server on your machine)
* Python 3.6.5+ and pip

## Install Instructions
* This project makes use of [Maticvigil-Python-SDK](https://github.com/blockvigil/maticvigil-python-sdk), in-order
  to interact with smart contracts. You will need to setup a maticvigil account. Use this 
  [link](https://maticvigil.com/docs/web_onboarding) which lists step-by-step on how to create a new account and also
  deploy and interact with smart contracts. Once you've done creating your account, go to the settings tab in the WebUI
  and click on Export Account button. Save the settings.json to /home/\<user\>/.maticvigil folder on your local system. 
  
* Install mv-cli using this [guide](https://maticvigil.com/docs/cli_onboarding). Once installation is done, 
run the following commands:
  
```shell
mv-cli importsettings /home/<user>/.maticvigil/settings.json
mv-cli accountinfo
```

* Install the required python packages:

```shell
pip install -r requirements.txt
```
  
* Install IPFS. This [link](https://docs.ipfs.io/install/) will help you do that

## Deploy contract and add a Webhook

* Once you've successfully created your maticvigil account, then you need to deploy the contract **AuditRecordStore.sol** which
can be found inside the project folder. You can deploy the contract through WebUI and a Webhook there itself. 
  [Deploy Contract through WebUI](https://maticvigil.com/docs/web_onboarding#deploy-a-solidity-smart-contract) 
  
## Configuring settings
* There is a **settings.example.json** file in the project folder. Navigate to the project and the type the following
command: 
  
```shell
cp settings.example.json settings.json
```

* Open up the settings.json file. There you need to edit two feilds:
  - contract_address: Add the contract address of the AuditContractStore contract that you deployed in the previous step
  - api_key: This field is present in /home/\<user\>/.maticvigil/settings.json file. Copy paste it here
  
* Other fields are ports for main webhook listener services. By default, they are set 
to 9000 and 90002, but if you already have some services running at that ports, you can 
  change them to any others that are free in your system.
  
## Running the services
* start the redis-server
* run the ipfs daemon
* make sure you webhook is up and running
* run all five services:

```shell
python gunicorn_main_launcher.py &
python gunicorn_webhook_launcher.py &
python payload_commit_service.py &
python pruning_service.py &
python retrieval_service.py &
```
  
## Run through docker
* Alternatively, you can run the entire project through docker.
* Copy up the docker settings file

```shell
cp docker_settings.example.json docker_settings.json
```

* Make the necessary changes with **contract_address** and **api_key fields**.
* Bring up the docker:

```
./run_docker.sh
```

## Usage
Try to commit some payload:
```shell
curl --location --request POST 'http://127.0.0.1:9000/commit_payload' \
--header 'Content-Type: text/plain' \
--data-raw '{
  "payload": {
      "test_field_a": "put any kind data here",
      "test_field_b": {
          "key_a": [1, 2],
          "key_b": 5000
      }
  },
  "projectId": "test_project_1"
}

```
The response you get should be:
```shell
{
    "cid": "QmQa7YZLitKkcMwRmZnx93wSEYjmtUxZgfdMJ1TQwSxgDa",
    "tentativeHeight": 1,
    "payloadChanged": true
}
```

There are 3 fields in the above response body:

- cid: This represents the content-identifier for the payload committed. It is a unique
hash for the payload field.
  
- tentativeHeight: Every new payload committed will have height that represents its position
in the chain of payloads committed. However tentativeHeight is not a deterministic value. If
  the proof for this payload is not recieved in the backend, the payload is discarded.
  
- payloadChanged: Represents whether the payload has changed from previous commit or not


There are endpoints which you can access to get dag blocks and retrieve the complete payload data:
- POST /commit_payload
- POST /{projectID}/diffRules
- GET /{prjectID}/getDiffRules
- GET /{projectID}/payloads/height
- GET /{projectID}/payload/{blockHeight}
- GET /{projectID}/payload/{blockHeight}/data
- GET /{projectID}/payloads
- GET /requests/{requestID}
- GET /projects/updates
- GET /{projectID}/payloads/cachedDiffs/count
- GET /{projectID}/payloads/cachedDiffs